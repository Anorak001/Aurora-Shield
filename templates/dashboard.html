<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Shield - Service Dashboard</title>
    <style>
        /* Reset & base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html,body { height: 100%; }

        /* Aurora Shield dark theme colors - matching attack simulator */
        :root{
            --bg-900: #0b1220; /* page background */
            --bg-800: #0f1726; /* card outer */
            --bg-700: #121627; /* card inner */
            --panel: linear-gradient(180deg, rgba(16,20,35,0.85), rgba(12,14,24,0.7));
            --accent: #9b7cff; /* soft purple */
            --accent-2: #7ee0f6; /* teal highlight */
            --success: #00ff88;
            --warning: #ffa502;
            --danger: #ff4757;
            --muted: #98a0b3;
            --glass: rgba(255,255,255,0.03);
            --card-glow: rgba(123, 87, 232, 0.12);
        }

        body{
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(1000px 400px at 10% 10%, rgba(123,87,232,0.06), transparent 10%),
                        radial-gradient(800px 300px at 90% 90%, rgba(53,60,188,0.04), transparent 12%),
                        var(--bg-900);
            color: #dbe6ff;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            min-height:100vh;
        }

        .container{ max-width:1400px; margin:0 auto; padding: 24px; }

        /* Header */
        .header{ text-align:left; margin-bottom:32px; }
        .header h1{ font-size:32px; color:var(--accent); letter-spacing:0.4px; margin-bottom: 8px; }
        .header p{ color:var(--muted); margin-top:6px; font-size: 16px; }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: linear-gradient(180deg, rgba(20,24,40,0.4), rgba(10,12,20,0.3));
            border-radius: 12px;
            padding: 6px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            letter-spacing: 0.4px;
        }

        .tab-btn.active {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: #07102a;
            box-shadow: 0 4px 12px rgba(155,124,255,0.3);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.04);
            color: #dbe6ff;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Panel styles (cards) */
        .status-panel,
        .service-panel,
        .actions-panel,
        .sinkhole-panel {
            background: linear-gradient(180deg, rgba(20,24,40,0.6), rgba(10,12,20,0.55));
            border: 1px solid rgba(255,255,255,0.04);
            border-radius:14px;
            padding:24px;
            margin-bottom:24px;
            box-shadow: 0 6px 30px rgba(3,6,20,0.6), 0 0 40px var(--card-glow) inset;
            backdrop-filter: blur(6px) saturate(120%);
        }

        /* Small accent stripe on panels */
        .status-panel::before,
        .service-panel::before,
        .actions-panel::before,
        .sinkhole-panel::before {
            content: '';
            height:4px; display:block; width:100%;
            background: linear-gradient(90deg, rgba(155,124,255,0.9), rgba(126,224,246,0.6));
            border-radius: 12px 12px 0 0; margin-bottom:16px; 
            box-shadow: 0 6px 18px rgba(124,79,255,0.08) inset;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Stats Grid */
        .stats-grid{ 
            display:grid; 
            grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); 
            gap:16px; 
            margin-bottom:16px; 
        }

        .stat-card{
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border-radius:12px; padding:20px; text-align:center;
            position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 8px 24px rgba(2,6,20,0.6);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card::after{
            content:''; position:absolute; right:-40%; top:-40%; width:260px; height:260px; border-radius:50%;
            background: radial-gradient(circle at 30% 30%, rgba(155,124,255,0.06), transparent 35%);
            transform: rotate(15deg);
        }

        .stat-value{ font-size:28px; font-weight:700; color:var(--accent); margin-bottom:8px; position: relative; z-index: 1; }
        .stat-label{ color:var(--muted); font-size:13px; font-weight: 500; position: relative; z-index: 1; }

        /* Services Grid */
        .services-grid{ 
            display:grid; 
            grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); 
            gap:20px; 
        }

        .service-card{
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border-radius:12px; padding:20px; border:1px solid rgba(255,255,255,0.03);
            transition: transform .18s ease, box-shadow .18s ease; position:relative; overflow:hidden;
            box-shadow: 0 8px 24px rgba(2,6,20,0.4);
        }

        .service-card:hover{ 
            transform: translateY(-4px); 
            box-shadow: 0 18px 50px rgba(3,6,30,0.6), 0 0 40px rgba(123,87,232,0.06); 
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .service-name {
            font-size: 18px;
            font-weight: 700;
            color: #e6e9ff;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }

        .status-running, .status-healthy { background-color: var(--success); box-shadow: 0 0 12px rgba(0,255,136,0.4); }
        .status-stopped, .status-unhealthy { background-color: var(--danger); box-shadow: 0 0 12px rgba(255,71,87,0.4); }
        .status-starting { background-color: var(--warning); box-shadow: 0 0 12px rgba(255,165,2,0.4); }
        .status-unknown { background-color: var(--muted); }

        .service-info {
            margin: 8px 0;
            font-size: 14px;
            color: var(--muted);
        }

        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        /* Buttons */
        .btn{ 
            padding:10px 18px; 
            border-radius:8px; 
            cursor:pointer; 
            font-weight:600; 
            border:none; 
            letter-spacing:0.4px; 
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .btn-primary{ 
            background: linear-gradient(90deg,var(--accent), var(--accent-2)); 
            color:#07102a; 
        }
        .btn-primary:hover{ filter:brightness(1.1); transform: translateY(-1px); }

        .btn-secondary{ 
            background: linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); 
            color: #dbe6ff; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover{ 
            background: linear-gradient(90deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08)); 
            transform: translateY(-1px);
        }

        .btn-danger{ 
            background: linear-gradient(90deg,#ff758c,#dc3545); 
            color:white; 
        }
        .btn-danger:hover{ filter:brightness(0.95); transform: translateY(-1px); }

        /* Actions Table */
        .actions-table {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .actions-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .actions-table th {
            background: linear-gradient(90deg, rgba(155,124,255,0.1), rgba(126,224,246,0.05));
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .actions-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 13px;
            color: #dbe6ff;
        }

        .actions-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .request-method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }

        .method-get { background: rgba(0,255,136,0.2); color: var(--success); }
        .method-post { background: rgba(155,124,255,0.2); color: var(--accent); }

        /* Threats Table (similar to actions table but with threat-specific styling) */
        .threats-table {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .threats-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .threats-table th {
            background: linear-gradient(90deg, rgba(255,71,87,0.1), rgba(255,165,2,0.05));
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-2);
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .threats-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 13px;
            color: #dbe6ff;
        }

        .threats-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }

        .status-badge.warning { 
            background: rgba(255,165,2,0.2); 
            color: var(--warning); 
        }
        
        .status-badge.danger { 
            background: rgba(255,71,87,0.2); 
            color: var(--danger); 
        }
        .method-put { background: rgba(255,165,2,0.2); color: var(--warning); }
        .method-delete { background: rgba(255,71,87,0.2); color: var(--danger); }

        .status-code {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .status-200 { background: rgba(0,255,136,0.2); color: var(--success); }
        .status-300 { background: rgba(255,165,2,0.2); color: var(--warning); }
        .status-400, .status-500 { background: rgba(255,71,87,0.2); color: var(--danger); }

        /* URL Links */
        .url-link {
            display: inline-block;
            margin: 4px 8px 4px 0;
            padding: 6px 12px;
            background: rgba(126,224,246,0.1);
            border: 1px solid rgba(126,224,246,0.3);
            border-radius: 6px;
            color: var(--accent-2);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .url-link:hover {
            background: rgba(126,224,246,0.2);
            color: white;
            transform: translateY(-1px);
        }

        /* Refresh Button */
        .refresh-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--accent-2));
            border: none;
            color: #07102a;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(155,124,255,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 12px 32px rgba(155,124,255,0.5);
        }

        /* Auto refresh indicator */
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-size: 12px;
            margin-top: 16px;
        }

        .refresh-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Responsive */
        @media (max-width:768px){ 
            .stats-grid{ grid-template-columns: repeat(2,1fr); } 
            .services-grid{ grid-template-columns: 1fr; }
            .tab-navigation { flex-wrap: wrap; }
            .service-actions { flex-direction: column; }
            .actions-table { overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Aurora Shield Dashboard</h1>
            <p>Monitor services, view system status, and track incoming attack simulator requests</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab-btn" onclick="switchTab('services')">‚öôÔ∏è Services</button>
            <button class="tab-btn" onclick="switchTab('actions')">üéØ Actions</button>
            <button class="tab-btn" onclick="switchTab('sinkhole')">üï≥Ô∏è Sinkhole</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="status-panel">
                <div class="panel-title">üìä System Overview</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="services-running">0</div>
                        <div class="stat-label">Services Running</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="services-healthy">0</div>
                        <div class="stat-label">Healthy Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-requests">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="requests-per-sec">0</div>
                        <div class="stat-label">Requests/sec</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-response-time">0ms</div>
                        <div class="stat-label">Avg Response Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="attack-simulators">0</div>
                        <div class="stat-label">Attack Simulators</div>
                    </div>
                </div>
                <div class="auto-refresh">
                    <span class="refresh-dot"></span>
                    Auto-refreshing every 5 seconds
                </div>
            </div>
        </div>

        <!-- Services Tab -->
        <div id="services-tab" class="tab-content">
            <div class="service-panel">
                <div class="panel-title">‚öôÔ∏è Service Management</div>
                <div class="services-grid" id="servicesGrid">
                    <!-- Services will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Actions Tab -->
        <div id="actions-tab" class="tab-content">
            <div class="actions-panel">
                <div class="panel-title">üéØ Attack Simulator Actions</div>
                <p style="color: var(--muted); margin-bottom: 20px;">Real-time monitoring of requests from attack simulators and clients</p>
                
                <div class="actions-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Method</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Response Time</th>
                                <th>Attack Type</th>
                            </tr>
                        </thead>
                        <tbody id="actionsTableBody">
                            <!-- Actions will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="auto-refresh" style="margin-top: 16px;">
                    <span class="refresh-dot"></span>
                    Monitoring live requests from attack simulators
                </div>
            </div>
        </div>

        <!-- Sinkhole Management Tab -->
        <div id="sinkhole-tab" class="tab-content">
            <div class="sinkhole-panel">
                <div class="panel-title">üï≥Ô∏è Sinkhole & Blackhole Management</div>
                <p style="color: var(--muted); margin-bottom: 20px;">Manage malicious actor isolation and traffic redirection</p>
                
                <!-- Sinkhole Status Overview -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">Quarantined IPs</div>
                        <div class="stat-value" id="quarantinedCount">-</div>
                        <div class="stat-change">Auto-quarantine active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sinkholed IPs</div>
                        <div class="stat-value" id="sinkholedCount">-</div>
                        <div class="stat-change">Traffic redirected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Blackholed IPs</div>
                        <div class="stat-value" id="blackholedCount">-</div>
                        <div class="stat-change">Completely blocked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Violation Score</div>
                        <div class="stat-value" id="avgViolationScore">-</div>
                        <div class="stat-change">System average</div>
                    </div>
                </div>

                <!-- Manual Actions -->
                <div class="action-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div class="control-group">
                        <h3 style="color: var(--accent); margin-bottom: 12px;">üï≥Ô∏è Add to Sinkhole</h3>
                        <div class="input-group">
                            <input type="text" id="sinkholeTarget" placeholder="IP or subnet (e.g., 192.168.1.100 or 192.168.1.0/24)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: var(--bg-700); border: 1px solid #333; color: #dbe6ff; border-radius: 4px;">
                            <input type="text" id="sinkholeReason" placeholder="Reason for sinkholing" style="width: 100%; padding: 8px; margin-bottom: 12px; background: var(--bg-700); border: 1px solid #333; color: #dbe6ff; border-radius: 4px;">
                            <button onclick="addToSinkhole()" style="width: 100%; padding: 10px; background: var(--accent); border: none; border-radius: 4px; color: white; cursor: pointer;">Add to Sinkhole</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h3 style="color: var(--danger); margin-bottom: 12px;">‚ö´ Add to Blackhole</h3>
                        <div class="input-group">
                            <input type="text" id="blackholeTarget" placeholder="IP or subnet (e.g., 10.0.0.100 or 10.0.0.0/24)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: var(--bg-700); border: 1px solid #333; color: #dbe6ff; border-radius: 4px;">
                            <input type="text" id="blackholeReason" placeholder="Reason for blackholing" style="width: 100%; padding: 8px; margin-bottom: 12px; background: var(--bg-700); border: 1px solid #333; color: #dbe6ff; border-radius: 4px;">
                            <button onclick="addToBlackhole()" style="width: 100%; padding: 10px; background: var(--danger); border: none; border-radius: 4px; color: white; cursor: pointer;">Add to Blackhole</button>
                        </div>
                    </div>
                </div>

                <!-- Active Threats Table -->
                <div class="threats-table">
                    <h3 style="color: var(--accent-2); margin-bottom: 16px;">üéØ Active Threat Management</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>IP/Subnet</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Violations</th>
                                <th>Last Activity</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="threatsTableBody">
                            <!-- Threats will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="auto-refresh" style="margin-top: 16px;">
                    <span class="refresh-dot"></span>
                    Auto-updating threat intelligence
                </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshAllData()" title="Refresh All Data">
        üîÑ
    </button>

    <script>
        let services = {{ services | tojsonfilter }};
        let statusData = {};
        let currentTab = 'overview';
        let requestLog = [];
        let refreshInterval;

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Refresh data for the current tab
            refreshTabData();
        }

        function refreshTabData() {
            switch(currentTab) {
                case 'overview':
                    refreshOverviewData();
                    break;
                case 'services':
                    refreshServiceData();
                    break;
                case 'actions':
                    refreshActionsData();
                    break;
                case 'sinkhole':
                    refreshSinkholeData();
                    break;
            }
        }

        function refreshOverviewData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    statusData = data;
                    updateOverviewStats();
                })
                .catch(error => console.error('Error fetching overview data:', error));
        }

        function refreshServiceData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    statusData = data;
                    updateServiceCards();
                })
                .catch(error => console.error('Error fetching service data:', error));
        }

        function refreshActionsData() {
            fetch('/api/actions')
                .then(response => response.json())
                .then(data => {
                    if (data.actions) {
                        requestLog = data.actions;
                        updateActionsTable();
                    }
                })
                .catch(error => console.error('Error fetching actions data:', error));
        }

        function updateOverviewStats() {
            let runningServices = 0;
            let healthyServices = 0;
            let totalRequests = 0;
            let avgResponseTime = 0;
            let responseCount = 0;

            for (const [serviceKey, status] of Object.entries(statusData)) {
                if (status.status === 'running') runningServices++;
                if (status.health === 'healthy') healthyServices++;
                if (status.response_time) {
                    avgResponseTime += status.response_time;
                    responseCount++;
                }
            }

            if (responseCount > 0) {
                avgResponseTime = (avgResponseTime / responseCount * 1000).toFixed(0);
            }

            document.getElementById('services-running').textContent = runningServices;
            document.getElementById('services-healthy').textContent = healthyServices;
            document.getElementById('total-requests').textContent = requestLog.length;
            document.getElementById('requests-per-sec').textContent = calculateRequestsPerSecond();
            document.getElementById('avg-response-time').textContent = avgResponseTime + 'ms';
            document.getElementById('attack-simulators').textContent = Object.keys(statusData).filter(k => k.includes('client')).length;
        }

        function calculateRequestsPerSecond() {
            const now = Date.now();
            const lastMinute = requestLog.filter(req => (now - new Date(req.timestamp).getTime()) < 60000);
            return Math.round(lastMinute.length / 60);
        }

        function updateServiceCards() {
            const grid = document.getElementById('servicesGrid');
            grid.innerHTML = '';
            
            for (const [serviceKey, serviceInfo] of Object.entries(services)) {
                const status = statusData[serviceKey] || {};
                const card = createServiceCard(serviceKey, serviceInfo, status);
                grid.appendChild(card);
            }
        }

        function createServiceCard(serviceKey, serviceInfo, status) {
            const card = document.createElement('div');
            card.className = 'service-card';
            
            const containerStatus = status.status || 'unknown';
            const healthStatus = status.health || 'unknown';
            
            const portInfo = serviceInfo.port ? `Port: ${serviceInfo.port}` : 'Internal service';
            const urlLink = serviceInfo.port && serviceInfo.port !== 6379 ? 
                `<a href="http://localhost:${serviceInfo.port}" target="_blank" class="url-link">üîó Open Service</a>` : '';
            
            card.innerHTML = `
                <div class="service-header">
                    <div class="service-name">
                        ${serviceInfo.name}
                        <span class="status-indicator status-${containerStatus}"></span>
                    </div>
                    <div>
                        <span class="status-indicator status-${healthStatus}"></span>
                    </div>
                </div>
                <div class="service-info">${serviceInfo.description}</div>
                <div class="service-info">${portInfo}</div>
                <div class="service-info">Status: ${containerStatus}</div>
                ${status.response_time ? `<div class="service-info">Response: ${(status.response_time * 1000).toFixed(0)}ms</div>` : ''}
                <div style="margin-top: 12px;">
                    ${urlLink}
                </div>
                <div class="service-actions">
                    <button class="btn btn-primary" onclick="restartService('${serviceKey}')">üîÑ Restart</button>
                    <button class="btn btn-secondary" onclick="viewServiceLogs('${serviceKey}')">üìã Logs</button>
                </div>
            `;
            
            return card;
        }

        function updateActionsTable() {
            const tbody = document.getElementById('actionsTableBody');
            const sortedRequests = [...requestLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentRequests = sortedRequests.slice(0, 100); // Show last 100 requests

            tbody.innerHTML = recentRequests.map(request => `
                <tr>
                    <td>${new Date(request.timestamp).toLocaleTimeString()}</td>
                    <td>${request.source || 'Unknown'}</td>
                    <td><span class="request-method method-${request.method?.toLowerCase() || 'get'}">${request.method || 'GET'}</span></td>
                    <td>${request.target || request.url || 'N/A'}</td>
                    <td><span class="status-code status-${Math.floor((request.status || 200) / 100) * 100}">${request.status || 200}</span></td>
                    <td>${request.response_time ? (request.response_time * 1000).toFixed(0) + 'ms' : 'N/A'}</td>
                    <td>${request.attack_type || 'Normal'}</td>
                </tr>
            `).join('');
        }

        function restartService(service) {
            if (!confirm(`Are you sure you want to restart ${service}?`)) return;
            
            fetch(`/api/restart/${service}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ ${service} restarted successfully`);
                        setTimeout(refreshTabData, 2000);
                    } else {
                        alert(`‚ùå Error restarting ${service}: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Error restarting service');
                });
        }

        function viewServiceLogs(service) {
            fetch(`/api/logs/${service}`)
                .then(response => response.json())
                .then(data => {
                    const logs = data.logs || data.error || 'No logs available';
                    alert(`Logs for ${service}:\n\n${logs.slice(0, 2000)}`);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Error fetching logs');
                });
        }

        function refreshAllData() {
            refreshTabData();
            
            // Add rotation effect to refresh button
            const btn = document.querySelector('.refresh-btn');
            btn.style.transform = 'scale(1.1) rotate(360deg)';
            setTimeout(() => {
                btn.style.transform = '';
            }, 300);
        }

        // Simulate incoming requests for demonstration
        function simulateIncomingRequests() {
            const sources = ['Attack Simulator 1', 'Attack Simulator 2', 'Attack Simulator 3', 'Client Bot'];
            const methods = ['GET', 'POST', 'PUT', 'DELETE'];
            const targets = [
                'http://localhost:8080/api/dashboard/stats',
                'http://localhost:80/',
                'http://localhost:8081/',
                'http://localhost:8082/',
                'http://localhost:8090/cdn/'
            ];
            const attackTypes = ['HTTP Flood', 'Slowloris', 'Normal', 'DDoS', 'Brute Force'];
            const statuses = [200, 200, 200, 403, 404, 500, 503];

            if (Math.random() < 0.3) { // 30% chance every 2 seconds
                const newRequest = {
                    timestamp: new Date().toISOString(),
                    source: sources[Math.floor(Math.random() * sources.length)],
                    method: methods[Math.floor(Math.random() * methods.length)],
                    target: targets[Math.floor(Math.random() * targets.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    response_time: Math.random() * 0.5 + 0.05, // 50ms to 550ms
                    attack_type: attackTypes[Math.floor(Math.random() * attackTypes.length)]
                };
                
                requestLog.push(newRequest);
                
                // Keep only last 500 requests
                if (requestLog.length > 500) {
                    requestLog = requestLog.slice(-500);
                }
                
                // Update actions table if it's the current tab
                if (currentTab === 'actions') {
                    updateActionsTable();
                }
            }
        }

        // Sinkhole Management Functions
        function refreshSinkholeData() {
            fetch('/api/sinkhole/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSinkholeStats(data.data);
                        updateThreatsTable(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching sinkhole status:', error);
                });
        }

        function updateSinkholeStats(data) {
            const counts = data.statistics?.counts || {};
            document.getElementById('quarantinedCount').textContent = counts.quarantined_ips || 0;
            document.getElementById('sinkholedCount').textContent = counts.sinkholed_ips || 0;
            document.getElementById('blackholedCount').textContent = counts.blackholed_ips || 0;
            
            // Calculate average violation score from stats
            const stats = data.statistics?.stats || {};
            const avgScore = stats.total_malicious_ips || 0;
            document.getElementById('avgViolationScore').textContent = avgScore.toString();
        }

        function updateThreatsTable(data) {
            const tableBody = document.getElementById('threatsTableBody');
            let rows = '';
            
            // Combine all threats from different categories
            const threats = [];
            
            // Add sinkholed IPs from recent actions
            if (data.recent_actions) {
                data.recent_actions.forEach(action => {
                    if (action.action === 'sinkhole' || action.action === 'blackhole') {
                        const target = action.target.replace('IP ', '').replace('Subnet ', '');
                        threats.push({
                            target: target,
                            type: action.target.includes('Subnet') ? 'Subnet' : 'IP',
                            status: action.action === 'blackhole' ? 'Blackholed' : 'Sinkholed',
                            violations: 'N/A',
                            lastActivity: new Date(action.timestamp * 1000).toLocaleString(),
                            reason: action.reason || 'Auto-escalation'
                        });
                    }
                });
            }
            
            threats.forEach(threat => {
                const statusClass = threat.status === 'Blackholed' ? 'danger' : 'warning';
                const statusEmoji = threat.status === 'Blackholed' ? '‚ö´' : 'üï≥Ô∏è';
                
                rows += `
                    <tr>
                        <td style="font-family: monospace;">${threat.target}</td>
                        <td>${threat.type}</td>
                        <td><span class="status-badge ${statusClass}">${statusEmoji} ${threat.status}</span></td>
                        <td>${threat.violations}</td>
                        <td>${threat.lastActivity}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${threat.reason}</td>
                        <td>
                            <button onclick="removeThreat('${threat.target}')" style="padding: 4px 8px; background: var(--muted); border: none; border-radius: 3px; color: white; cursor: pointer; font-size: 12px;">Remove</button>
                        </td>
                    </tr>
                `;
            });
            
            if (threats.length === 0) {
                rows = '<tr><td colspan="7" style="text-align: center; color: var(--muted); padding: 20px;">No active threats detected</td></tr>';
            }
            
            tableBody.innerHTML = rows;
        }

        function addToSinkhole() {
            const target = document.getElementById('sinkholeTarget').value.trim();
            const reason = document.getElementById('sinkholeReason').value.trim();
            
            if (!target) {
                alert('Please enter an IP or subnet to sinkhole');
                return;
            }
            
            const data = {
                target: target,
                type: target.includes('/') ? 'subnet' : 'ip',
                reason: reason || `Manual action via dashboard`
            };
            
            fetch('/api/sinkhole/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`Successfully added ${target} to sinkhole`);
                    document.getElementById('sinkholeTarget').value = '';
                    document.getElementById('sinkholeReason').value = '';
                    refreshSinkholeData();
                } else {
                    alert(`Error: ${result.error}`);
                }
            })
            .catch(error => {
                alert(`Error adding to sinkhole: ${error}`);
            });
        }

        function addToBlackhole() {
            const target = document.getElementById('blackholeTarget').value.trim();
            const reason = document.getElementById('blackholeReason').value.trim();
            
            if (!target) {
                alert('Please enter an IP or subnet to blackhole');
                return;
            }
            
            const data = {
                target: target,
                type: target.includes('/') ? 'subnet' : 'ip',
                reason: reason || `Manual blackhole via dashboard`
            };
            
            fetch('/api/blackhole/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`Successfully added ${target} to blackhole`);
                    document.getElementById('blackholeTarget').value = '';
                    document.getElementById('blackholeReason').value = '';
                    refreshSinkholeData();
                } else {
                    alert(`Error: ${result.error}`);
                }
            })
            .catch(error => {
                alert(`Error adding to blackhole: ${error}`);
            });
        }

        function removeThreat(target) {
            if (!confirm(`Remove ${target} from threat isolation?`)) {
                return;
            }
            
            // This would need a backend endpoint to remove threats
            alert('Remove threat functionality would be implemented here');
        }

        // Auto-refresh and simulation
        function startAutoRefresh() {
            refreshTabData();
            refreshInterval = setInterval(() => {
                refreshTabData();
                simulateIncomingRequests();
            }, 5000);
            
            // More frequent simulation
            setInterval(simulateIncomingRequests, 2000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
        });
    </script>
</body>
</html>